{% extends "base.html" %}
{% block content %}

<!-- Scoped, surgical CSS for THIS page only -->
<style>
  /* Container: force single column and kill any inherited grid/flex/float rules */
  #payCard {
    display: grid !important;
    grid-template-columns: 1fr !important;
    gap: 12px;
    max-width: 420px;
    margin: auto;
    text-align: center;
  }
  #payCard > * {
    grid-column: 1 / -1 !important;
    float: none !important;
    max-width: 100% !important;
  }

  /* Card box where Square mounts */
  #card-container {
    padding: 12px;
    border: 1px solid #22324d;
    border-radius: 8px;
    background: #0f1a2b;
  }

  /* Terms block: centered write-up for visibility */
  .tandc {
    background: #141f35;
    padding: 12px;
    border-radius: 8px;
  }
  .tandc label {
    display: grid;                 /* easy centering */
    grid-auto-flow: column;
    align-items: start;
    justify-content: center;       /* center checkbox + text as a group */
    gap: 10px;
    text-align: center;            /* center the write-up text */
    line-height: 1.45;
  }
  .tandc input[type="checkbox"] {
    margin-top: 3px;
  }
  .tandc a {
    color: #3ba9ff;
    text-decoration: none;
  }

  /* Button: full width and clear hover/disabled states */
  #payBtn {
    width: 100%;
    padding: 12px 0;
    border: none;
    border-radius: 6px;
    font-weight: 600;
    font-size: 16px;
    background: #1e5cff;
    color: #fff;
    transition: 0.25s ease;
  }
  #payBtn:hover { background: #3770ff; }
  #payBtn:disabled { opacity: 0.5; cursor: not-allowed; }

  /* Error line */
  #err { color: #ff7b7b; min-height: 1.2em; }
</style>

<section class="card" id="payCard">
  <h2>Card / Debit Payment</h2>
  <p>Amount: ${{ amount_usd }} â€¢ Ticket: <code>{{ order.ticket_id }}</code></p>

  <!-- Card field (Square mounts here) -->
  <div id="card-container"></div>

  <!-- Terms & Conditions (UNDER card, ABOVE button) -->
  <div class="tandc">
    <label for="agreeTerms">
      <input id="agreeTerms" type="checkbox">
      <span style="color:#d0d6e1;">
        I accept the
        <a href="{{ url_for('terms') }}"></a>
        and agree to the Refund &amp; Dispute Policy.
      </span>
    </label>
  </div>

  <!-- Pay button -->
  <button id="payBtn" class="btn" type="button" disabled>Pay Now</button>

  <!-- Error display -->
  <div id="err"></div>
</section>

<!-- Square Web Payments SDK -->
<script src="https://web.squarecdn.com/v1/square.js"></script>
<script>
  document.addEventListener('DOMContentLoaded', async () => {
    const errBox   = document.getElementById('err');
    const agreeBox = document.getElementById('agreeTerms');
    const payBtn   = document.getElementById('payBtn');

    // Keep Pay button locked until Terms checked
    const syncBtn = () => {
      payBtn.disabled = !agreeBox.checked;
      payBtn.style.opacity = agreeBox.checked ? "1" : "0.5";
    };
    agreeBox.addEventListener('change', syncBtn);
    syncBtn();

    try {
      const appId = "{{ square_app_id }}";
      const locationId = "{{ square_location_id }}";
      if (!appId || !locationId) throw new Error("Missing Square credentials.");

      const payments = window.Square && window.Square.payments
        ? window.Square.payments(appId, locationId)
        : null;
      if (!payments) throw new Error("Square SDK not loaded.");

      const card = await payments.card();
      await card.attach('#card-container');

      payBtn.addEventListener('click', async () => {
        if (payBtn.disabled) return;
        errBox.textContent = '';
        payBtn.disabled = true;

        try {
          const result = await card.tokenize();
          if (result.status !== 'OK') {
            throw new Error((result.errors && result.errors[0] && result.errors[0].message) || 'Could not tokenize card.');
          }

          const res = await fetch("{{ url_for('square_pay_card') }}", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ token: result.token })
          });

          const j = await res.json();
          if (res.ok && j.ok) {
            window.location.href = j.view_url;
          } else {
            throw new Error((j && j.error) || 'Payment failed.');
          }
        } catch (err) {
          console.error(err);
          errBox.textContent = err.message || 'Payment failed.';
          syncBtn();
        }
      });
    } catch (e) {
      console.error(e);
      errBox.textContent = e.message || 'Square initialization failed.';
    }
  });
</script>
{% endblock %}