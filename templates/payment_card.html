{% extends "base.html" %}
{% block content %}

<style>
  /* Scope fixes to this page only */
  .pay-card {
    display: grid !important;
    grid-template-columns: 1fr !important;  /* kill any 2-column grid from base.css */
    gap: 12px;
    max-width: 420px;
    margin: auto;
    text-align: center;
  }
  .pay-card * { float: none !important; }   /* in case base.css floats labels/links */
  .pay-card .stack { width: 100%; }

  /* Control vertical order */
  .pay-title { order: 1; }
  .pay-meta  { order: 2; }
  #card-container { order: 3; }
  .tandc { order: 4; }
  .pay-btn { order: 5; }
  .pay-err { order: 6; }

  /* Terms block layout */
  .tandc label {
    display: flex;
    align-items: flex-start;
    gap: 10px;
    line-height: 1.4;
  }
  .tandc label input { margin-top: 3px; flex: 0 0 auto; }
  .tandc a { text-decoration: none; }
</style>

<section class="card pay-card">
  <h2 class="pay-title">Card / Debit Payment</h2>
  <p class="pay-meta">Amount: ${{ amount_usd }} â€¢ Ticket: <code>{{ order.ticket_id }}</code></p>

  <!-- Card field -->
  <div id="card-container" class="stack"
       style="padding:12px;border:1px solid #22324d;border-radius:8px;background:#0f1a2b;"></div>

  <!-- Terms & Conditions (now UNDER card field, ABOVE Pay button) -->
  <div class="tandc stack" style="background:#141f35;padding:10px;border-radius:8px;text-align:left;">
    <label for="agreeTerms">
      <input id="agreeTerms" type="checkbox">
      <span style="color:#d0d6e1;">
        I accept the
        <a href="{{ url_for('index') }}#terms" target="_blank" style="color:#3ba9ff;">
          Terms &amp; Conditions
        </a>
        and agree to the Refund &amp; Dispute Policy.
      </span>
    </label>
  </div>

  <!-- Pay button -->
  <button id="payBtn" class="btn pay-btn stack" type="button" style="width:100%;" disabled>
    Pay Now
  </button>

  <!-- Error display -->
  <div id="err" class="pay-err" style="color:#ff7b7b;min-height:1.2em;"></div>
</section>

<!-- Square Web Payments SDK -->
<script src="https://web.squarecdn.com/v1/square.js"></script>
<script>
  document.addEventListener('DOMContentLoaded', async () => {
    const errBox   = document.getElementById('err');
    const agreeBox = document.getElementById('agreeTerms');
    const payBtn   = document.getElementById('payBtn');

    const syncBtn = () => {
      payBtn.disabled = !agreeBox.checked;
      payBtn.style.opacity = agreeBox.checked ? "1" : "0.5";
    };
    agreeBox.addEventListener('change', syncBtn);
    syncBtn();

    try {
      const appId = "{{ square_app_id }}";
      const locationId = "{{ square_location_id }}";
      if (!appId || !locationId) throw new Error("Missing Square credentials.");

      const payments = window.Square.payments(appId, locationId);
      const card = await payments.card();
      await card.attach('#card-container');

      payBtn.addEventListener('click', async () => {
        if (payBtn.disabled) return;
        errBox.textContent = '';
        payBtn.disabled = true;

        try {
          const result = await card.tokenize();
          if (result.status !== 'OK') {
            throw new Error(result?.errors?.[0]?.message || 'Could not tokenize card.');
          }

          const res = await fetch("{{ url_for('square_pay_card') }}", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ token: result.token })
          });

          const j = await res.json();
          if (res.ok && j.ok) window.location.href = j.view_url;
          else throw new Error(j.error || 'Payment failed.');
        } catch (err) {
          console.error(err);
          errBox.textContent = err.message || 'Payment failed.';
          syncBtn();
        }
      });
    } catch (e) {
      console.error(e);
      errBox.textContent = 'Square initialization failed.';
    }
  });
</script>
{% endblock %}